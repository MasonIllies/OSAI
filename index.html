<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OSAI</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <meta name="theme-color" content="#000000" />

  <!-- Fonts -->
  <link rel="preload" href="/fonts/Sansation-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="/fonts/Sansation-Bold.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="stylesheet" href="/fonts/fonts.css" />

  <!-- Site CSS -->
  <link rel="stylesheet" href="./css/styles.css" />

  <style>
    :root{
      /* Core palette */
      --bg-0: #07080a;
      --bg-1: #0a0c10;
      --bg-2: #0f1218;
      --text: #ffffff;
      --muted: rgba(255,255,255,.72);

      /* Glass + borders */
      --glass: rgba(255,255,255,.04);
      --glass-strong: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --stroke-soft: rgba(255,255,255,.06);
      --inner: rgba(255,255,255,.06);
      --ring: rgba(180,210,255,.20);

      /* Accents (subtle neon) */
      --glow-1: 220 85% 62%;   /* blue-cyan */
      --glow-2: 280 75% 62%;   /* violet     */

      --radius: 16px;
      --shadow: 0 24px 80px rgba(0,0,0,.70);
      --pad: 16px;
    }

    /* Global reset & luxury dark background with grain */
    *{ box-sizing:border-box }
    html, body { height:100% }
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% -10%, #0b1220 0%, transparent 55%),
        radial-gradient(1200px 800px at 110% 10%, #161018 0%, transparent 50%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-0) 100%);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      letter-spacing:.2px;
      font-family: "Sansation", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      position:relative;
      overflow-x: hidden;
    }
    /* ultra-fine grain overlay */
    body::before{
      content:"";
      position:fixed; inset:-2px; pointer-events:none; z-index:-1;
      background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='.15'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='table' tableValues='0 0 .02 .04 .06'/%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: soft-light;
    }

    .container{ max-width: 960px; margin: 0 auto; padding: 0 var(--pad) }
    .hero{ padding: 48px 0 88px }
    .footer{ padding: 40px 0; color: var(--muted); font-size: 13px }

    /* HEADER — deep glass, radiant hairline, floating */
    .glassbar{
      position: sticky; top: 0; z-index: 40;
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      background: linear-gradient(180deg, rgba(10,12,16,.85), rgba(10,12,16,.60));
      border-bottom: 1px solid var(--stroke-soft);
      box-shadow:
        0 10px 40px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.06);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 0; gap: 16px;
    }
    .brand{ text-decoration:none; color:var(--text); white-space:nowrap }
    .brand-text{
      font-size: 32px; line-height: 1.05; letter-spacing:.12em;
      font-weight: 800; text-transform: uppercase; opacity:.92;
    }
    .nav-link{ color: var(--muted); text-decoration:none; font-weight:800; white-space:nowrap }
    .nav-link.small{ font-size:32px }
    .nav-link:hover{ color: var(--text) }

    @media (max-width: 520px){
      .brand-text{ font-size: 22px }
      .nav-link.small{ font-size: 22px }
      .nav{ padding: 12px 0 }
    }

    /* HERO */
    .hero-title{
      margin: 8px 0 14px;
      font-weight: 800;
      line-height: 1.02;
      font-size: clamp(44px, 6vw, 64px);
      max-width: 22ch;
      text-wrap: balance;
      letter-spacing:.01em;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.82));
      -webkit-background-clip: text; background-clip: text;
      color: transparent;
      text-shadow: 0 6px 30px rgba(0,0,0,.65);
    }
    .lede{ color: var(--muted); margin: 8px 0 8px; line-height: 1.48; }
    .lede .u{ text-decoration: underline; text-underline-offset: 4px }
    .tiny-note{ font-size: 13px; color: var(--muted); margin: 6px 0 18px; position: relative; }
    .tiny-note::after{ content:""; display:block; width: 160px; height:1px; margin-top:8px; background: rgba(255,255,255,.16); }
    .ps{ font-size: 12px; color: var(--muted); font-style: italic; margin: 4px 0 18px; }

    /* 2025 GLASS CARD — subdued luxury */
    .card.video{
      position: relative; border-radius: var(--radius); padding: 14px; overflow: hidden;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)) padding-box;
      border: 1px solid var(--stroke);
      backdrop-filter: blur(18px) saturate(150%);
      -webkit-backdrop-filter: blur(18px) saturate(150%);
      box-shadow:
        0 18px 70px rgba(0,0,0,.65),
        0 2px 0 rgba(255,255,255,.04) inset;
      isolation: isolate;
    }
    /* Radiant perimeter + soft vignette */
    .card.video::before{
      content:"";
      position:absolute; inset:-1px; border-radius: calc(var(--radius) + 1px);
      pointer-events:none; z-index:1;
      background:
        conic-gradient(from 210deg,
          hsl(var(--glow-1) / .18) 0deg,
          transparent 60deg,
          transparent 220deg,
          hsl(var(--glow-2) / .18) 300deg,
          transparent 360deg);
      filter: blur(12px);
      opacity:.8;
      mask: linear-gradient(#000 55%, transparent 85%);
    }
    .card.video::after{
      content:"";
      position:absolute; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(120% 120% at 50% -10%, rgba(255,255,255,.12), transparent 45%),
        radial-gradient(80% 120% at 50% 120%, rgba(255,255,255,.06), transparent 55%);
      mix-blend-mode: screen;
    }

    .video .intro{
      position:absolute; top:14px; left:14px; z-index: 3;
      border: 1px solid var(--stroke); background: rgba(0,0,0,.48);
      backdrop-filter: blur(6px) saturate(120%);
      -webkit-backdrop-filter: blur(6px) saturate(120%);
    }
    .video-frame{
      aspect-ratio:16/9; width:100%;
      background: rgba(255,255,255,.015);
      border-radius: 12px; overflow: hidden;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.05),
        inset 0 -1px 0 rgba(255,255,255,.03);
      position:relative;
    }
    .play{
      position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; background: transparent; color: rgba(255,255,255,.94); border:0; cursor:pointer; font-weight:800;
      letter-spacing:.02em; transition: transform .14s ease, opacity .14s ease;
    }
    .play:hover{ transform: translateY(-1px); }
    .play-dot{
      width: 58px; height: 58px; border-radius: 9999px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(closest-side, rgba(255,255,255,.98), rgba(255,255,255,.92));
      color:#000; font-size: 20px; font-weight: 900;
      box-shadow:
        0 10px 28px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.7);
    }
    .play-label{ font-size: 13px; text-shadow: 0 1px 0 rgba(0,0,0,.45) }

    /* Spacing rhythm under video */
    .after-video{ margin-top: 54px }
    .after-video > * + *{ margin-top: 54px }

    /* Signup row */
    .signup{ text-align: center }
    .row{ display:flex; gap:10px; flex-wrap: wrap }
    .row.centered{ justify-content: center }
    input, select{
      border-radius: 12px; border: 1px solid var(--stroke);
      background: #fff; color:#000; padding: 12px 14px; outline: none;
      font: inherit; width: min(420px, 100%);
    }
    input:focus, select:focus{ box-shadow: 0 0 0 3px var(--ring) }
    .btn{
      display:inline-flex; align-items:center; gap:.5rem; border-radius: 12px;
      border:1px solid var(--stroke); padding:.85rem 1.05rem; font-weight:800;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      cursor:pointer
    }
    .btn.ghost{
      color: var(--text);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(8px) saturate(120%);
      -webkit-backdrop-filter: blur(8px) saturate(120%);
      box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .btn.ghost:hover{ background: var(--glass-strong) }

    /* Price line + pills */
    .price{ font-size: 18px; font-weight: 800; text-align: center }
    .price .strong{ font-weight: 900 }
    .muted{ color: var(--muted) }
    .pills{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center }
    .pill{
      display:inline-block; border-radius:9999px; font-weight:700; letter-spacing:.04em;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      padding:.46rem .86rem; font-size:.72rem; color:rgba(255,255,255,.94);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* MODALS — same solid black but refined micro-borders */
    .sheet{ position:fixed; inset:0; z-index:1000; }
    .sheet-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.62); backdrop-filter: blur(4px) }
    .sheet-card{
      position:relative; z-index:1;
      margin: 8vh auto 0 auto; max-width:560px; border-radius:16px; padding:20px;
      background:
        linear-gradient(180deg, rgba(10,12,16,.96), rgba(10,12,16,.92)) padding-box;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow:
        0 30px 80px rgba(0,0,0,.85),
        inset 0 1px 0 rgba(255,255,255,.05);
    }
    .sheet h3{ margin:0; font-size:22px }
    .sheet .divider{ height:1px; background:rgba(255,255,255,.14); margin:12px 0 6px }
    .sheet .muted-link{ color:rgba(255,255,255,.78); font-size:13px; text-decoration:underline; cursor:pointer }

    .form-row{ display:flex; flex-direction:column; gap:8px; position:relative; }
    .form-row + .form-row{ margin-top:12px }
    .row-split{ display:flex; gap:10px; flex-wrap:wrap }
    .row-split .form-row{ flex:1; min-width: 180px }
    .label{ font-size:13px; color:rgba(255,255,255,.75) }
    .input{ border-radius:12px; padding:12px 44px 12px 14px; border:1px solid rgba(255,255,255,.22); background:#fff; color:#000; font:inherit; width:100%; }
    .input:focus{ outline:none; box-shadow:0 0 0 3px var(--ring) }
    .toggle-eye{
      position:absolute; right:8px; top:32px;
      border:0; background:transparent; color:#333; cursor:pointer; font-size:13px; padding:6px 8px;
      z-index:2;
    }
    .row-two{ display:flex; gap:10px; flex-wrap:wrap }
    .row-two .btn{ flex:1 }
    .error-line{ color:#ff8a8a; font-size:12px; min-height:16px }
    .info-line{ color:#8ab4ff; font-size:12px; min-height:16px }
    .btn.primary{ background:#fff; color:#000; border-radius:12px; padding:.95rem 1.15rem; border:1px solid rgba(255,255,255,.22); font-weight:900 }
    .btn.primary[disabled]{ opacity:.5; cursor:not-allowed }

    /* Email dropdown */
    .email-wrap{ position:relative; display:inline-block; width:min(420px,100%) }
    .email-dd{ position:absolute; left:0; right:0; top:calc(100% + 6px); background:#0b0d10; border:1px solid rgba(255,255,255,.18); border-radius:10px; box-shadow:0 18px 40px rgba(0,0,0,.55); padding:6px; z-index:30; display:none; }
    .email-dd.open{ display:block }
    .email-item{ padding:10px 12px; border-radius:8px; cursor:pointer; color:#eaeaea; font-size:14px; display:flex; align-items:center; justify-content:space-between; }
    .email-item:hover, .email-item.active{ background:rgba(255,255,255,.08); }
    .email-hint{ color:rgba(255,255,255,.55); font-size:12px; margin-left:10px }

    /* Reduced transparency accessibility */
    @media (prefers-reduced-transparency: reduce){
      .glassbar, .card.video { backdrop-filter:none !important; -webkit-backdrop-filter:none !important; }
      .card.video{ background: rgba(22,24,30,.9); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="glassbar">
    <div class="container nav">
      <a class="brand" href="/"><span class="brand-text">MASIN’s OSAI</span></a>
      <a id="authLink" class="nav-link small" href="#">Login</a>
    </div>
  </header>

  <!-- Main -->
  <main>
    <section class="container hero">
      <h1 class="hero-title">
        Not just another shit app built<br />
        to farm your data and trick<br />
        you into forgetting your<br />
        subscription.
      </h1>

      <p class="lede">
        Give me $20 a month and I’ll give you <span class="u">everything</span> I can develop.<br />
        Owned–created, designed, developed, marketed, and sold by me—
      </p>

      <p class="tiny-note">Welcome to OSAI. Nice to meet you.</p>
      <p class="ps">p.s. Fuck you Google.</p>

      <!-- Video card -->
      <div class="card video">
        <span class="pill intro">INTRODUCTION VIDEO</span>
        <div class="video-frame" id="videoFrame">
          <button id="playBtn" class="play" aria-label="Play introduction video"
            data-video="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
            <div class="play-dot">▶</div>
            <span class="play-label">PLAY</span>
          </button>
        </div>
      </div>

      <!-- After video -->
      <div class="after-video">
        <div class="signup">
          <div class="row centered">
            <span class="email-wrap">
              <input id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" />
              <div id="emailDropdown" class="email-dd" role="listbox" aria-label="Email suggestions"></div>
            </span>
            <button id="openSignup" class="btn ghost">Sign up</button>
          </div>
        </div>

        <div class="price">
          $20/month — <span class="strong">everything I can develop.</span>
          <span class="muted">Early access + updates.</span>
        </div>

        <div class="pills">
          <span class="pill">CONTENT CREATION</span>
          <span class="pill">FINANCIAL PLANNING</span>
          <span class="pill">DAILY SCHEDULES</span>
          <span class="pill">CREATE YOUR OWN UI</span>
        </div>
      </div>
    </section>
  </main>

  <footer class="container footer">© <span id="year"></span> OSAI</footer>

  <!-- LOGIN SHEET -->
  <div id="loginSheet" class="sheet hidden" aria-hidden="true">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-card">
      <div class="sheet-head">
        <h3>Log in</h3>
        <button class="close" data-close aria-label="Close">✕</button>
      </div>
      <div class="divider"></div>

      <form id="loginForm" class="sheet-body" onsubmit="return false;">
        <div class="form-row">
          <label class="label" for="loginEmail">Email</label>
          <input id="loginEmail" class="input" type="email" required placeholder="you@example.com" autocomplete="email" />
        </div>
        <div class="form-row">
          <label class="label" for="loginPass">Password</label>
          <input id="loginPass" class="input" type="password" required placeholder="Your password" autocomplete="current-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="loginPass" aria-label="Show password">Show</button>
        </div>
        <div class="row-two">
          <button id="loginBtn" class="btn primary" type="submit">Login</button>
        </div>
        <p id="loginMsg" class="error-line"></p>
        <p class="muted-link" id="toSignup">Need an account? Create one</p>
      </form>
    </div>
  </div>

  <!-- CREATE ACCOUNT / PAY SHEET -->
  <div id="signupSheet" class="sheet hidden" aria-hidden="true">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-card">
      <div class="sheet-head">
        <h3>Create your account</h3>
        <button class="close" data-close aria-label="Close">✕</button>
      </div>

      <div class="divider"></div>

      <form id="sheetForm" class="sheet-body" onsubmit="return false;">
        <!-- Names -->
        <div class="form-row">
          <label class="label" for="sheetDisplay">Display name</label>
          <input id="sheetDisplay" class="input" type="text" required placeholder="Your public name" autocomplete="nickname" />
        </div>

        <div class="row-split">
          <div class="form-row">
            <label class="label" for="sheetFirst">First name</label>
            <input id="sheetFirst" class="input" type="text" required placeholder="First name" autocomplete="given-name" />
          </div>
          <div class="form-row">
            <label class="label" for="sheetLast">Last name</label>
            <input id="sheetLast" class="input" type="text" required placeholder="Last name" autocomplete="family-name" />
          </div>
        </div>

        <!-- Email -->
        <div class="form-row">
          <label class="label" for="sheetEmail">Email</label>
          <input id="sheetEmail" class="input" type="email" required placeholder="you@example.com" autocomplete="email" />
          <div id="errEmail" class="error-line"></div>
        </div>

        <!-- Passwords -->
        <div class="form-row">
          <label class="label" for="sheetPass">Password</label>
          <input id="sheetPass" class="input" type="password" required placeholder="Minimum 8 characters" autocomplete="new-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="sheetPass" aria-label="Show password">Show</button>
        </div>

        <div class="form-row">
          <label class="label" for="sheetPass2">Confirm password</label>
          <input id="sheetPass2" class="input" type="password" required placeholder="Re-enter password" autocomplete="new-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="sheetPass2" aria-label="Show password">Show</button>
          <div id="errPass" class="error-line"></div>
        </div>

        <div class="row-two">
          <button id="payBtn" class="btn primary" type="submit" disabled>PAY</button>
        </div>

        <p id="authMsg" class="info-line"></p>
        <p class="muted-link" id="toLogin">Already have an account? Log in</p>
        <p class="subtle">You’ll be charged $20/month. Cancel anytime.</p>
      </form>
    </div>
  </div>

  <!-- Inline JS -->
  <script type="module">
    // --------- SUPABASE (public) ----------
    const SUPABASE_URL = "https://cnsuyhvkpgtwlpqvwetn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuc3V5aHZrcGd0d2xwcXZ3ZXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjY1NzIsImV4cCI6MjA3MjQ0MjU3Mn0.tEPXUtNhZBY8ZLR0jFZtsoWewX62FDHd4QW7C3TVDS0";
    const STRIPE_LINK = "https://buy.stripe.com/bJe4gA1aRcJNaDVeg67g404";
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Footer year
    const y = document.getElementById("year"); if (y) y.textContent = new Date().getFullYear();

    // Video embed
    function toEmbed(url){
      try{
        const u=new URL(url);
        if(u.hostname.includes("youtu.be")){
          return "https://www.youtube.com/embed/"+u.pathname.replace("/","")+"?autoplay=1&rel=0";
        }
        if(u.hostname.includes("youtube.com")){
          if(u.pathname==="/watch"){
            const id=u.searchParams.get("v")||"";
            return "https://www.youtube.com/embed/"+id+"?autoplay=1&rel=0";
          }
          if(u.pathname.startsWith("/embed/")){
            return url.includes("autoplay=1") ? url : (url+(url.includes("?")?"&":"?")+"autoplay=1&rel=0");
          }
        }
      }catch(e){}
      return url;
    }
    (function(){
      const frame=document.getElementById("videoFrame");
      const btn=document.getElementById("playBtn");
      if(!frame||!btn) return;
      function inject(){
        if(frame.dataset.played==="1") return; frame.dataset.played="1";
        const raw=btn.getAttribute("data-video")||"https://www.youtube.com/watch?v=dQw4w9WgXcQ";
        const src=toEmbed(raw);
        const iframe=document.createElement("iframe");
        iframe.width="100%"; iframe.height="100%"; iframe.src=src;
        iframe.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
        iframe.allowFullscreen=true; iframe.title="Introduction video";
        frame.innerHTML=""; frame.appendChild(iframe);
      }
      btn.addEventListener("click", inject);
      btn.addEventListener("keydown", e => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); inject(); }});
    })();

    // Email suggestions
    (function(){
      const input = document.getElementById('emailInput');
      const dd    = document.getElementById('emailDropdown');
      if(!input || !dd) return;
      const DOMAINS = ["gmail.com","icloud.com","outlook.com","yahoo.com","proton.me","pm.me","hotmail.com","live.com","me.com","hey.com","aol.com","zoho.com","osai.llc"];
      let activeIndex = -1;
      const build = (v) => {
        v = (v||"").trim(); if(!v) return [];
        const at = v.indexOf('@'); const local = at===-1? v : v.slice(0,at); const dom = at===-1? "" : v.slice(at+1).toLowerCase();
        if(!local) return [];
        return DOMAINS.filter(d => dom ? d.startsWith(dom) : true).slice(0,8).map(d => `${local}@${d}`);
      };
      const render = list => {
        dd.innerHTML=""; activeIndex=-1;
        if(!list.length){ dd.classList.remove('open'); return; }
        list.forEach(s=>{
          const el=document.createElement('div'); el.className='email-item'; el.setAttribute('role','option');
          el.textContent=s; const hint=document.createElement('span'); hint.className='email-hint'; hint.textContent='Enter';
          el.appendChild(hint); el.addEventListener('mousedown', e=>{ e.preventDefault(); commit(s); });
          dd.appendChild(el);
        });
        dd.classList.add('open');
      };
      const commit = val => { input.value=val; dd.classList.remove('open'); activeIndex=-1; };
      const highlight = i => {
        const items=dd.querySelectorAll('.email-item'); items.forEach(el=>el.classList.remove('active'));
        if(i>=0 && i<items.length) items[i].classList.add('active');
      };
      input.addEventListener('input', ()=> render(build(input.value)));
      input.addEventListener('keydown', e=>{
        const items=dd.querySelectorAll('.email-item');
        if(e.key==='ArrowDown'){ if(!dd.classList.contains('open')){ render(build(input.value)); return; } activeIndex=Math.min(activeIndex+1, items.length-1); highlight(activeIndex); e.preventDefault(); }
        else if(e.key==='ArrowUp'){ if(!dd.classList.contains('open')) return; activeIndex=Math.max(activeIndex-1,0); highlight(activeIndex); e.preventDefault(); }
        else if(e.key==='Enter'){ if(dd.classList.contains('open') && activeIndex>=0 && items[activeIndex]){ commit(items[activeIndex].childNodes[0].textContent); e.preventDefault(); } }
        else if(e.key==='Escape'){ dd.classList.remove('open'); activeIndex=-1; }
      });
      document.addEventListener('click', e=>{ if(!dd.contains(e.target) && e.target !== input){ dd.classList.remove('open'); activeIndex=-1; }});
    })();

    // ===== SESSION/UI =====
    const authLink   = document.getElementById('authLink');
    const loginSheet = document.getElementById('loginSheet');
    const signupSheet= document.getElementById('signupSheet');

    function openSheet(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    function closeSheet(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

    function setAuthUI(session){
      if(session?.user){
        authLink.textContent = "Logout";
        authLink.onclick = async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); setAuthUI(null); };
      }else{
        authLink.textContent = "Login";
        authLink.onclick = (e)=>{ e.preventDefault(); openSheet(loginSheet); };
      }
    }
    async function refreshSessionUI(){
      const { data: { session } } = await supabase.auth.getSession();
      setAuthUI(session);
    }

    // Close handlers
    document.addEventListener('click', (e)=>{
      if(e.target.matches('#loginSheet [data-close]'))  closeSheet(loginSheet);
      if(e.target.matches('#signupSheet [data-close]')) closeSheet(signupSheet);
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        if(!loginSheet.classList.contains('hidden'))  closeSheet(loginSheet);
        if(!signupSheet.classList.contains('hidden')) closeSheet(signupSheet);
      }
    });

    // Toggle eye buttons
    document.querySelectorAll('.toggle-eye').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-toggle');
        const input = document.getElementById(id);
        if(!input) return;
        const showing = input.type === 'text';
        input.type = showing ? 'password' : 'text';
        btn.textContent = showing ? 'Show' : 'Hide';
        btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
      });
    });

    // ===== LOGIN =====
    const loginForm = document.getElementById('loginForm');
    const loginEmail= document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const loginBtn  = document.getElementById('loginBtn');
    const loginMsg  = document.getElementById('loginMsg');
    const toSignup  = document.getElementById('toSignup');

    toSignup.addEventListener('click', ()=>{
      closeSheet(loginSheet); openSheet(signupSheet);
      setTimeout(()=> document.getElementById('sheetEmail')?.focus(), 0);
    });

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      loginMsg.textContent = "";
      loginBtn.disabled = true; loginBtn.textContent = "Logging in…";
      const email = (loginEmail.value || "").trim();
      const pass  = loginPass.value || "";

      if(!email || !pass){
        loginBtn.disabled = false; loginBtn.textContent = "Login";
        loginMsg.textContent = "Enter email and password.";
        return;
      }
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if(error) throw error;
        closeSheet(loginSheet);
        await refreshSessionUI();
      }catch(err){
        loginMsg.textContent = err?.message || "Login failed.";
      }finally{
        loginBtn.disabled = false; loginBtn.textContent = "Login";
      }
    });

    // ===== SIGNUP + USERNAME RESERVE + STRIPE =====
    const openSignupBtn = document.getElementById('openSignup');
    const toLogin       = document.getElementById('toLogin');

    const sheetForm     = document.getElementById('sheetForm');
    const sheetDisplay  = document.getElementById('sheetDisplay');
    const sheetFirst    = document.getElementById('sheetFirst');
    const sheetLast     = document.getElementById('sheetLast');
    const sheetEmail    = document.getElementById('sheetEmail');
    const sheetPass     = document.getElementById('sheetPass');
    const sheetPass2    = document.getElementById('sheetPass2');
    const errEmail      = document.getElementById('errEmail');
    const errPass       = document.getElementById('errPass');
    const payBtn        = document.getElementById('payBtn');
    const authMsg       = document.getElementById('authMsg');

    openSignupBtn.addEventListener('click', ()=>{
      openSheet(signupSheet);
      const src = document.getElementById('emailInput');
      if(src?.value?.trim()) sheetEmail.value = src.value.trim();
      setTimeout(()=> sheetDisplay?.focus(), 0);
      validateSignup();
    });
    toLogin.addEventListener('click', ()=>{
      closeSheet(signupSheet); openSheet(loginSheet);
      setTimeout(()=> loginEmail?.focus(), 0);
    });

    function nonEmpty(v){ return (v||"").trim().length >= 1; }
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    function validateSignup(){
      let ok = true;
      if(!nonEmpty(sheetDisplay.value)) ok = false;
      if(!nonEmpty(sheetFirst.value)) ok = false;
      if(!nonEmpty(sheetLast.value)) ok = false;

      const e = (sheetEmail.value || '').trim();
      if(!emailRe.test(e)){ errEmail.textContent="Enter a valid email."; ok=false; } else { errEmail.textContent=""; }

      const p1 = sheetPass.value || '';
      const p2 = sheetPass2.value || '';
      if(p1.length < 8){ errPass.textContent="Password must be at least 8 characters."; ok=false; }
      else if(p1 !== p2){ errPass.textContent="Passwords don’t match."; ok=false; }
      else { errPass.textContent=""; }

      payBtn.disabled = !ok;
      return ok;
    }
    [sheetDisplay, sheetFirst, sheetLast, sheetEmail, sheetPass, sheetPass2].forEach(el => {
      el.addEventListener('input', validateSignup);
    });

    sheetForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!validateSignup()) return;

      payBtn.disabled = true; payBtn.textContent = "Creating…";
      authMsg.textContent = "";

      const email = sheetEmail.value.trim();
      const pass  = sheetPass.value;

      // 1) Create or sign-in Supabase user
      const { error: signUpErr } = await supabase.auth.signUp({
        email,
        password: pass,
        options: {
          emailRedirectTo: window.location.origin,
          data: {
            display_name: sheetDisplay.value.trim(),
            first_name: sheetFirst.value.trim(),
            last_name: sheetLast.value.trim()
          }
        }
      });
      if(signUpErr && !/already registered/i.test(signUpErr.message || "")){
        payBtn.disabled = false; payBtn.textContent = "PAY";
        errEmail.textContent = signUpErr.message || "Sign up failed.";
        return;
      }
      if(signUpErr && /already registered/i.test(signUpErr.message || "")){
        const { error: signInErr } = await supabase.auth.signInWithPassword({ email, password: pass });
        if(signInErr){
          payBtn.disabled = false; payBtn.textContent = "PAY";
          errEmail.textContent = signInErr.message || "Sign in failed.";
          return;
        }
      }

      // 2) Reserve username (DB unique + reserved-name triggers enforce it)
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr || !user) {
        payBtn.disabled = false; payBtn.textContent = "PAY";
        authMsg.textContent = "Could not get session.";
        return;
      }

      const wanted = sheetDisplay.value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '').slice(0,20);
      if (wanted.length < 3) {
        payBtn.disabled = false; payBtn.textContent = "PAY";
        authMsg.textContent = "Username must be 3–20 chars (a–z, 0–9, _).";
        return;
      }

      const { error: profileErr } = await supabase.from("profiles").insert({
        id: user.id,
        username: wanted,
        display_name: sheetDisplay.value.trim(),
        first_name: sheetFirst.value.trim(),
        last_name: sheetLast.value.trim()
      });

      if (profileErr) {
        payBtn.disabled = false; payBtn.textContent = "PAY";
        const msg = profileErr.code === '23505'
          ? "That username is already taken."
          : (profileErr.code === '23514'
            ? "That username is reserved. Try another."
            : (profileErr.message || "Could not save profile.")
          );
        authMsg.textContent = msg;
        return;
      }

      // 3) Proceed to Stripe hosted Checkout link
      payBtn.textContent = "Redirecting…";
      window.location.href = STRIPE_LINK;
    });

    // Auth UI init
    supabase.auth.onAuthStateChange((_event, session)=> setAuthUI(session));
    refreshSessionUI();
  </script>
</body>
</html>
