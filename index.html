<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OSAI</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <meta name="theme-color" content="#000000" />

  <!-- Fonts (kept) -->
  <link rel="preload" href="/fonts/Sansation-Regular.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="preload" href="/fonts/Sansation-Bold.ttf" as="font" type="font/ttf" crossorigin>
  <link rel="stylesheet" href="/fonts/fonts.css" />

  <!-- Site CSS (kept) -->
  <link rel="stylesheet" href="./css/styles.css" />

  <style>
    :root{
      --obsidian-0:#050607;
      --obsidian-1:#0a0b0d;
      --obsidian-2:#0f1115;
      --obsidian-edge:#1b1e24;
      --obsidian-stroke: rgba(255,255,255,.06);
      --obsidian-hi: rgba(255,255,255,.08);
      --obsidian-whisper: rgba(255,255,255,.03);
    }

    /* Scaled desktop composition that shrinks as ONE unit */
    .hero-shell{ width:100%; display:flex; justify-content:center; overflow:hidden; }
    .hero-scale{ width:980px; transform-origin: top center; will-change: transform; }

    /* Lock to exactly two lines (breaks only where you place <br/>) */
    .hero-title{
      white-space: pre;
      display:inline-block;
      line-height:1.05;
      letter-spacing:.002em;
      font-size:56px;
      margin:0 0 14px 0;
    }

    .lede{ font-size:18px; line-height:1.35; }

    /* ----- Obsidian video card ----- */
    .card.video{
      position: relative;
      border-radius: 20px;
      padding: 14px;
      background:
        linear-gradient(180deg, var(--obsidian-whisper), transparent),
        var(--obsidian-2);
      border: 1px solid var(--obsidian-stroke);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      box-shadow:
        0 28px 80px rgba(0,0,0,.78),
        inset 0 1px 0 var(--obsidian-hi),
        inset 0 -1px 0 rgba(0,0,0,.85);
      overflow: hidden;
      perspective: 1200px;
      transform-style: preserve-3d;
      will-change: transform;
    }
    .card.video::after{
      content:"";
      position:absolute; left:1px; right:1px; top:1px; height: 22px; border-radius: 19px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,0));
      filter: blur(.25px);
      pointer-events:none; z-index:3; transform: translateZ(1px);
    }

    .obsidian-slab{
      position:absolute; inset: -22px -22px -26px -22px; border-radius: 28px;
      z-index:0; pointer-events:none; will-change: transform, opacity;
      background:
        radial-gradient(120% 160% at 50% 10%, rgba(255,255,255,.05), rgba(255,255,255,0) 60%),
        repeating-linear-gradient(25deg, rgba(255,255,255,.03) 0 2px, rgba(255,255,255,0) 2px 10px),
        repeating-linear-gradient(-18deg, rgba(255,255,255,.015) 0 1px, rgba(255,255,255,0) 1px 12px),
        var(--obsidian-0);
      box-shadow:
        0 40px 90px rgba(0,0,0,.85),
        0 12px 30px rgba(0,0,0,.65),
        inset 0 1px 0 rgba(255,255,255,.06),
        inset 0 -1px 0 rgba(0,0,0,.9);
      border: 1px solid var(--obsidian-edge);
      -webkit-mask:
        radial-gradient(120% 140% at 50% -20% , rgba(0,0,0,0) 0 35%, rgba(0,0,0,1) 60%),
        linear-gradient(#000,#000);
              mask:
        radial-gradient(120% 140% at 50% -20% , rgba(0,0,0,0) 0 35%, rgba(0,0,0,1) 60%),
        linear-gradient(#000,#000);
      transform: translateZ(-18px) rotateX(0deg) rotateY(0deg);
    }
    .obsidian-slab::before{
      content:""; position:absolute; inset:0; border-radius: inherit;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 45%) top/100% 24px no-repeat,
        linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,0) 55%) bottom/100% 30px no-repeat;
      mix-blend-mode: screen; opacity:.7;
    }

    .video-frame{
      aspect-ratio:16/9; width:100%;
      background:
        radial-gradient(120% 140% at 50% 0%, rgba(255,255,255,.04), rgba(255,255,255,0) 60%),
        var(--obsidian-1);
      border-radius: 14px; overflow: hidden;
      border: 2px solid var(--obsidian-stroke);
      box-shadow:
        inset 0 2px 10px rgba(0,0,0,.9),
        0 16px 44px rgba(0,0,0,.65);
      position:relative; z-index:2; transform: translateZ(0);
    }

    /* Doubled label size */
    .pill.intro{
      position:absolute; top:14px; left:14px; z-index:4;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.6);
      font-weight:700; font-size:24px; letter-spacing:.08em;
      padding:.45rem .8rem; border-radius:999px;
      user-select:none;
    }

    .play{
      position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; background: transparent; color: rgba(255,255,255,.92); border:0; cursor:pointer; font-weight:700;
      letter-spacing:.02em; transition: transform .15s ease;
    }
    .play:hover{ transform: translateY(-1px); }
    .play-dot{
      width: 56px; height: 56px; border-radius: 9999px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.96), rgba(255,255,255,.86));
      color:#000; font-size: 20px; font-weight: 800;
      box-shadow: 0 10px 22px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.65);
    }
    .play-label{ font-size: 13px; text-shadow: 0 1px 0 rgba(0,0,0,.6) }

    /* Email dropdown (kept) */
    .email-wrap{ position:relative; display:inline-block; width:min(420px,100%) }
    .email-dd{ position:absolute; left:0; right:0; top:calc(100% + 6px); background:#0b0d10; border:1px solid rgba(255,255,255,.18); border-radius:10px; box-shadow:0 18px 40px rgba(0,0,0,.55); padding:6px; z-index:30; display:none; }
    .email-dd.open{ display:block }
    .email-item{ padding:10px 12px; border-radius:8px; cursor:pointer; color:#eaeaea; font-size:14px; display:flex; align-items:center; justify-content:space-between; }
    .email-item:hover, .email-item.active{ background:rgba(255,255,255,.08); }
    .email-hint{ color:rgba(255,255,255,.55); font-size:12px; margin-left:10px }
  </style>
</head>

<!-- Additive: Checkout bootstrap -->
<script type="module">
  const CHECKOUT_PRICE_ID = "price_1S6eI9J0uj5iBUehTf0MCJyr";
  const SUCCESS_URL = `https://www.osai.llc/?success=1`;
  const CANCEL_URL  = `https://www.osai.llc/?canceled=1`;

  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const byId = (id) => document.getElementById(id);

  const signupForm   = byId("signupForm")   || $("form#signupForm");
  const signupButton = byId("signupPayBtn") || $("#signupPayBtn,[data-pay]");
  const authMsgEl    = byId("authMsg")      || $("#authMsg,.auth-msg");

  function showAuthMsg(msg){ if (authMsgEl) authMsgEl.textContent = msg; else console.warn("[OSAI]", msg); }

  async function createCheckoutSession() {
    try {
      const resp = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ priceId: CHECKOUT_PRICE_ID, successUrl: SUCCESS_URL, cancelUrl: CANCEL_URL })
      });
      const json = await resp.json();
      if (!resp.ok || !json?.url) throw new Error(json?.error || "Checkout init failed.");
      window.location.href = json.url;
    } catch (err) {
      showAuthMsg(err.message || "Checkout error.");
      if (signupButton) { signupButton.disabled = false; signupButton.textContent = "PAY"; }
    }
  }

  if (signupForm && signupButton) {
    signupForm.addEventListener("osai:checkout", (e) => {
      e.preventDefault();
      if (signupButton) { signupButton.disabled = true; signupButton.textContent = "Redirecting…"; }
      createCheckoutSession();
    });

    signupButton.addEventListener("click", () => {
      if (signupButton.dataset.osaiHandled) return;
      signupButton.dataset.osaiHandled = "1";
      setTimeout(() => { if (!document.hidden) createCheckoutSession(); }, 350);
    }, { capture: true });
  }
</script>

<body>
  <!-- Header -->
  <header class="glassbar">
    <div class="container nav">
      <a class="brand" href="/"><span class="brand-text">MASIN’s OSAI</span></a>
      <a id="authLink" class="nav-link small" href="#">Login</a>
    </div>
  </header>

  <!-- Main -->
  <main>
    <section class="container hero">
      <div class="hero-shell" id="heroShell">
        <div class="hero-scale" id="heroScale">
          <h1 class="hero-title">
Not just another shit app built to farm your data<br />
and trick you into forgetting your subscription.
          </h1>

          <p class="lede">
            Give me $20 a month and I’ll give you <span class="u">everything</span> I can develop.<br />
            Owned–created, designed, developed, marketed, and sold by me—
          </p>

          <p class="tiny-note">Welcome to OSAI. Nice to meet you.</p>
          <p class="ps">p.s. Fuck you Google.</p>

          <!-- Video card -->
          <div class="card video" id="videoCard">
            <span class="pill intro">INTRODUCTION VIDEO</span>
            <div class="obsidian-slab" aria-hidden="true" id="obsidianSlab"></div>

            <div class="video-frame" id="videoFrame">
              <button id="playBtn" class="play" aria-label="Play introduction video"
                data-video="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                <div class="play-dot">▶</div>
                <span class="play-label">PLAY</span>
              </button>
            </div>
          </div>

          <!-- After video -->
          <div class="after-video">
            <div class="signup">
              <div class="row centered">
                <span class="email-wrap">
                  <input id="emailInput" type="email" placeholder="you@example.com" autocomplete="email" />
                  <div id="emailDropdown" class="email-dd" role="listbox" aria-label="Email suggestions"></div>
                </span>
                <button id="openSignup" class="btn ghost">Sign up</button>
              </div>
            </div>

            <div class="price">
              $20/month — <span class="strong">everything I can develop.</span>
              <span class="muted">Early access + updates.</span>
            </div>

            <div class="pills">
              <span class="pill">CONTENT CREATION</span>
              <span class="pill">FINANCIAL PLANNING</span>
              <span class="pill">DAILY SCHEDULES</span>
              <span class="pill">CREATE YOUR OWN UI</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="container footer">© <span id="year"></span> OSAI</footer>

  <!-- LOGIN SHEET -->
  <div id="loginSheet" class="sheet hidden" aria-hidden="true">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-card">
      <div class="sheet-head">
        <h3>Log in</h3>
        <button class="close" data-close aria-label="Close">✕</button>
      </div>
      <div class="divider"></div>

      <form id="loginForm" class="sheet-body" onsubmit="return false;">
        <div class="form-row">
          <label class="label" for="loginEmail">Email</label>
          <input id="loginEmail" class="input" type="email" required placeholder="you@example.com" autocomplete="email" />
        </div>
        <div class="form-row">
          <label class="label" for="loginPass">Password</label>
          <input id="loginPass" class="input" type="password" required placeholder="Your password" autocomplete="current-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="loginPass" aria-label="Show password">Show</button>
        </div>
        <div class="row-two">
          <button id="loginBtn" class="btn primary" type="submit">Login</button>
        </div>
        <p id="loginMsg" class="error-line"></p>
        <p class="muted-link" id="forgotLink">Forgot password?</p>
        <p class="muted-link" id="toSignup">Need an account? Create one</p>
      </form>
    </div>
  </div>

  <!-- CREATE ACCOUNT / PAY SHEET -->
  <div id="signupSheet" class="sheet hidden" aria-hidden="true">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-card">
      <div class="sheet-head">
        <h3>Create your account</h3>
        <button class="close" data-close aria-label="Close">✕</button>
      </div>

      <div class="divider"></div>

      <form id="sheetForm" class="sheet-body" onsubmit="return false;">
        <!-- Names -->
        <div class="form-row">
          <label class="label" for="sheetDisplay">Display name</label>
          <input id="sheetDisplay" class="input" type="text" required placeholder="Your public name" autocomplete="nickname" />
        </div>

        <div class="row-split">
          <div class="form-row">
            <label class="label" for="sheetFirst">First name</label>
            <input id="sheetFirst" class="input" type="text" required placeholder="First name" autocomplete="given-name" />
          </div>
          <div class="form-row">
            <label class="label" for="sheetLast">Last name</label>
            <input id="sheetLast" class="input" type="text" required placeholder="Last name" autocomplete="family-name" />
          </div>
        </div>

        <!-- Email -->
        <div class="form-row">
          <label class="label" for="sheetEmail">Email</label>
          <input id="sheetEmail" class="input" type="email" required placeholder="you@example.com" autocomplete="email" />
          <div id="errEmail" class="error-line"></div>
        </div>

        <!-- Passwords -->
        <div class="form-row">
          <label class="label" for="sheetPass">Password</label>
          <input id="sheetPass" class="input" type="password" required placeholder="Minimum 8 characters" autocomplete="new-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="sheetPass" aria-label="Show password">Show</button>
        </div>

        <div class="form-row">
          <label class="label" for="sheetPass2">Confirm password</label>
          <input id="sheetPass2" class="input" type="password" required placeholder="Re-enter password" autocomplete="new-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="sheetPass2" aria-label="Show password">Show</button>
          <div id="errPass" class="error-line"></div>
        </div>

        <div class="row-two">
          <button id="payBtn" class="btn primary" type="submit" disabled>PAY</button>
        </div>

        <p id="authMsg" class="info-line"></p>
        <p class="muted-link" id="toLogin">Already have an account? Log in</p>
        <p class="subtle">You’ll be charged $20/month. Cancel anytime.</p>
      </form>
    </div>
  </div>

  <!-- RESET PASSWORD SHEET -->
  <div id="resetSheet" class="sheet hidden" aria-hidden="true">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-card">
      <div class="sheet-head">
        <h3>Reset your password</h3>
        <button class="close" data-close aria-label="Close">✕</button>
      </div>
      <div class="divider"></div>

      <form id="resetForm" class="sheet-body" onsubmit="return false;">
        <p class="muted" style="margin:0">Enter a new password for your account.</p>

        <div class="form-row">
          <label class="label" for="resetPass">New password</label>
          <input id="resetPass" class="input" type="password" required placeholder="Minimum 8 characters" autocomplete="new-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="resetPass" aria-label="Show password">Show</button>
        </div>

        <div class="form-row">
          <label class="label" for="resetPass2">Confirm new password</label>
          <input id="resetPass2" class="input" type="password" required placeholder="Re-enter password" autocomplete="new-password" minlength="8" />
          <button type="button" class="toggle-eye" data-toggle="resetPass2" aria-label="Show password">Show</button>
          <div id="resetErr" class="error-line"></div>
        </div>

        <div class="row-two">
          <button id="resetBtn" class="btn primary" type="submit">Update password</button>
        </div>

        <p id="resetMsg" class="info-line"></p>
      </form>
    </div>
  </div>

  <!-- Inline JS -->
  <script type="module">
    // --------- SUPABASE (public) ----------
    const SUPABASE_URL = "https://cnsuyhvkpgtwlpqvwetn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuc3V5aHZrcGd0d2xwcXZ3ZXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjY1NzIsImV4cCI6MjA3MjQ0MjU3Mn0.tEPXUtNhZBY8ZLR0jFZtsoWewX62FDHd4QW7C3TVDS0";
    const STRIPE_LINK = "https://buy.stripe.com/bJe4gA1aRcJNaDVeg67g404";

    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Footer year
    const y = document.getElementById("year"); if (y) y.textContent = new Date().getFullYear();

    // Video embed
    function toEmbed(url){
      try{
        const u=new URL(url);
        if(u.hostname.includes("youtu.be")){
          return "https://www.youtube.com/embed/"+u.pathname.replace("/","")+"?autoplay=1&rel=0";
        }
        if(u.hostname.includes("youtube.com")){
          if(u.pathname==="/watch"){
            const id=u.searchParams.get("v")||"";
            return "https://www.youtube.com/embed/"+id+"?autoplay=1&rel=0";
          }
          if(u.pathname.startsWith("/embed/")){
            return url.includes("autoplay=1") ? url : (url+(url.includes("?")?"&":"?")+"autoplay=1&rel=0");
          }
        }
      }catch(e){}
      return url;
    }
    (function(){
      const frame=document.getElementById("videoFrame");
      const btn=document.getElementById("playBtn");
      if(!frame||!btn) return;
      function inject(){
        if(frame.dataset.played==="1") return; frame.dataset.played="1";
        const raw=btn.getAttribute("data-video")||"https://www.youtube.com/watch?v=dQw4w9WgXcQ";
        const src=toEmbed(raw);
        const iframe=document.createElement("iframe");
        iframe.width="100%"; iframe.height="100%"; iframe.src=src;
        iframe.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
        iframe.allowFullscreen=true; iframe.title="Introduction video";
        frame.innerHTML=""; frame.appendChild(iframe);
      }
      btn.addEventListener("click", inject);
      btn.addEventListener("keydown", e => { if(e.key==="Enter"||e.key===" "){ e.preventDefault(); inject(); }});
    })();

    // Email suggestions
    (function(){
      const input = document.getElementById('emailInput');
      const dd    = document.getElementById('emailDropdown');
      if(!input || !dd) return;
      const DOMAINS = ["gmail.com","icloud.com","outlook.com","yahoo.com","proton.me","pm.me","hotmail.com","live.com","me.com","hey.com","aol.com","zoho.com","osai.llc"];
      let activeIndex = -1;
      const build = (v) => {
        v = (v||"").trim(); if(!v) return [];
        const at = v.indexOf('@'); const local = at===-1? v : v.slice(0,at); const dom = at===-1? "" : v.slice(at+1).toLowerCase();
        if(!local) return [];
        return DOMAINS.filter(d => dom ? d.startsWith(dom) : true).slice(0,8).map(d => `${local}@${d}`);
      };
      const render = list => {
        dd.innerHTML=""; activeIndex=-1;
        if(!list.length){ dd.classList.remove('open'); return; }
        list.forEach(s=>{
          const el=document.createElement('div'); el.className='email-item'; el.setAttribute('role','option');
          el.textContent=s; const hint=document.createElement('span'); hint.className='email-hint'; hint.textContent='Enter';
          el.appendChild(hint); el.addEventListener('mousedown', e=>{ e.preventDefault(); commit(s); });
          dd.appendChild(el);
        });
        dd.classList.add('open');
      };
      const commit = val => { input.value=val; dd.classList.remove('open'); activeIndex=-1; };
      const highlight = i => {
        const items=dd.querySelectorAll('.email-item'); items.forEach(el=>el.classList.remove('active'));
        if(i>=0 && i<items.length) items[i].classList.add('active');
      };
      input.addEventListener('input', ()=> render(build(input.value)));
      input.addEventListener('keydown', e=>{
        const items=dd.querySelectorAll('.email-item');
        if(e.key==='ArrowDown'){ if(!dd.classList.contains('open')){ render(build(input.value)); return; } activeIndex=Math.min(activeIndex+1, items.length-1); highlight(activeIndex); e.preventDefault(); }
        else if(e.key==='ArrowUp'){ if(!dd.classList.contains('open')) return; activeIndex=Math.max(activeIndex-1,0); highlight(activeIndex); e.preventDefault(); }
        else if(e.key==='Enter'){ if(dd.classList.contains('open') && activeIndex>=0 && items[activeIndex]){ commit(items[activeIndex].childNodes[0].textContent); e.preventDefault(); } }
        else if(e.key==='Escape'){ dd.classList.remove('open'); activeIndex=-1; }
      });
      document.addEventListener('click', e=>{ if(!dd.contains(e.target) && e.target !== input){ dd.classList.remove('open'); activeIndex=-1; }});
    })();

    // ========== SESSION/UI ==========
    const authLink   = document.getElementById('authLink');
    const loginSheet = document.getElementById('loginSheet');
    const signupSheet= document.getElementById('signupSheet');
    const resetSheet = document.getElementById('resetSheet');

    function openSheet(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    function closeSheet(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

    function setAuthUI(session){
      if(session?.user){
        authLink.textContent = "Logout";
        authLink.onclick = async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); setAuthUI(null); };
      }else{
        authLink.textContent = "Login";
        authLink.onclick = (e)=>{ e.preventDefault(); openSheet(loginSheet); };
      }
    }
    async function refreshSessionUI(){
      const { data: { session } } = await supabase.auth.getSession();
      setAuthUI(session);
    }

    // Close handlers
    document.addEventListener('click', (e)=>{
      if(e.target.matches('#loginSheet [data-close]'))  closeSheet(loginSheet);
      if(e.target.matches('#signupSheet [data-close]')) closeSheet(signupSheet);
      if(e.target.matches('#resetSheet [data-close]'))  closeSheet(resetSheet);
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        if(!loginSheet.classList.contains('hidden'))  closeSheet(loginSheet);
        if(!signupSheet.classList.contains('hidden')) closeSheet(signupSheet);
        if(!resetSheet.classList.contains('hidden'))  closeSheet(resetSheet);
      }
    });

    // Toggle eye buttons (all)
    document.querySelectorAll('.toggle-eye').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-toggle');
        const input = document.getElementById(id);
        if(!input) return;
        const showing = input.type === 'text';
        input.type = showing ? 'password' : 'text';
        btn.textContent = showing ? 'Show' : 'Hide';
        btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
      });
    });

    // ======= LOGIN FLOW =======
    const loginForm  = document.getElementById('loginForm');
    const loginEmail = document.getElementById('loginEmail');
    const loginPass  = document.getElementById('loginPass');
    const loginBtn   = document.getElementById('loginBtn');
    const loginMsg   = document.getElementById('loginMsg');
    const toSignup   = document.getElementById('toSignup');
    const forgotLink = document.getElementById('forgotLink');

    toSignup.addEventListener('click', ()=>{
      closeSheet(loginSheet); openSheet(signupSheet);
      setTimeout(()=> document.getElementById('sheetEmail')?.focus(), 0);
    });

    forgotLink.addEventListener('click', async ()=>{
      loginMsg.textContent = "";
      const email = (loginEmail.value || "").trim();
      if(!email){ loginMsg.textContent = "Enter your email above first."; return; }
      try{
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
        if(error) throw error;
        loginMsg.textContent = "Reset link sent. Check your email.";
      }catch(err){
        loginMsg.textContent = err?.message || "Could not send reset email.";
      }
    });

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      loginMsg.textContent = "";
      loginBtn.disabled = true; loginBtn.textContent = "Logging in…";
      const email = (loginEmail.value || "").trim();
      const pass  = loginPass.value || "";

      if(!email || !pass){
        loginBtn.disabled = false; loginBtn.textContent = "Login";
        loginMsg.textContent = "Enter email and password.";
        return;
      }
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if(error) throw error;
        closeSheet(loginSheet);
        await refreshSessionUI();
      }catch(err){
        loginMsg.textContent = err?.message || "Login failed.";
      }finally{
        loginBtn.disabled = false; loginBtn.textContent = "Login";
      }
    });

    // ======= SIGNUP + USERNAME RESERVE + STRIPE (fallback) =======
    const openSignupBtn = document.getElementById('openSignup');
    const toLogin       = document.getElementById('toLogin');

    const sheetForm     = document.getElementById('sheetForm');
    const sheetDisplay  = document.getElementById('sheetDisplay');
    const sheetFirst    = document.getElementById('sheetFirst');
    const sheetLast     = document.getElementById('sheetLast');
    const sheetEmail    = document.getElementById('sheetEmail');
    const sheetPass     = document.getElementById('sheetPass');
    const sheetPass2    = document.getElementById('sheetPass2');
    const errEmail      = document.getElementById('errEmail');
    const errPass       = document.getElementById('errPass');
    const payBtn        = document.getElementById('payBtn');
    const authMsg       = document.getElementById('authMsg');

    openSignupBtn.addEventListener('click', ()=>{
      openSheet(signupSheet);
      const src = document.getElementById('emailInput');
      if(src?.value?.trim()) sheetEmail.value = src.value.trim();
      setTimeout(()=> sheetDisplay?.focus(), 0);
      validateSignup();
    });
    toLogin.addEventListener('click', ()=>{
      closeSheet(signupSheet); openSheet(loginSheet);
      setTimeout(()=> loginEmail?.focus(), 0);
    });

    function nonEmpty(v){ return (v||"").trim().length >= 1; }
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    function validateSignup(){
      let ok = true;
      if(!nonEmpty(sheetDisplay.value)) ok = false;
      if(!nonEmpty(sheetFirst.value)) ok = false;
      if(!nonEmpty(sheetLast.value)) ok = false;

      const e = (sheetEmail.value || '').trim();
      if(!emailRe.test(e)){ errEmail.textContent="Enter a valid email."; ok=false; } else { errEmail.textContent=""; }

      const p1 = sheetPass.value || '';
      const p2 = sheetPass2.value || '';
      if(p1.length < 8){ errPass.textContent="Password must be at least 8 characters."; ok=false; }
      else if(p1 !== p2){ errPass.textContent="Passwords don’t match."; ok=false; }
      else { errPass.textContent=""; }

      payBtn.disabled = !ok;
      return ok;
    }
    [sheetDisplay, sheetFirst, sheetLast, sheetEmail, sheetPass, sheetPass2].forEach(el => {
      el.addEventListener('input', validateSignup);
    });

    sheetForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!validateSignup()) return;

      payBtn.disabled = true; payBtn.textContent = "Creating…";
      authMsg.textContent = "";

      const email = sheetEmail.value.trim();
      const pass  = sheetPass.value;

      // 1) Create or sign-in Supabase user
      const { error: signUpErr } = await supabase.auth.signUp({
        email,
        password: pass,
        options: {
          emailRedirectTo: window.location.origin,
          data: {
            display_name: sheetDisplay.value.trim(),
            first_name: sheetFirst.value.trim(),
            last_name: sheetLast.value.trim()
          }
        }
      });
      if(signUpErr && !/already registered/i.test(signUpErr.message || "")){
        payBtn.disabled = false; payBtn.textContent = "PAY";
        errEmail.textContent = signUpErr.message || "Sign up failed.";
        return;
      }
      if(signUpErr && /already registered/i.test(signUpErr.message || "")){
        const { error: signInErr } = await supabase.auth.signInWithPassword({ email, password: pass });
        if(signInErr){
          payBtn.disabled = false; payBtn.textContent = "PAY";
          errEmail.textContent = signInErr.message || "Sign in failed.";
          return;
        }
      }

      // 2) Reserve username
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr || !user) {
        payBtn.disabled = false; payBtn.textContent = "PAY";
        authMsg.textContent = "Could not get session.";
        return;
      }

      const wanted = sheetDisplay.value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '').slice(0,20);
      if (wanted.length < 3) {
        payBtn.disabled = false; payBtn.textContent = "PAY";
        authMsg.textContent = "Username must be 3–20 chars (a–z, 0–9, _).";
        return;
      }

      const { error: profileErr } = await supabase.from("profiles").insert({
        id: user.id,
        username: wanted,
        display_name: sheetDisplay.value.trim(),
        first_name: sheetFirst.value.trim(),
        last_name: sheetLast.value.trim()
      });

      if (profileErr) {
        payBtn.disabled = false; payBtn.textContent = "PAY";
        const msg = profileErr.code === '23505'
          ? "That username is already taken."
          : (profileErr.code === '23514'
            ? "That username is reserved. Try another."
            : (profileErr.message || "Could not save profile.")
          );
        authMsg.textContent = msg;
        return;
      }

      // 3) Fallback (kept)
      payBtn.textContent = "Redirecting…";
      window.location.href = STRIPE_LINK;
    });

    // ---------- Reset password flow ----------
    const resetForm = document.getElementById('resetForm');
    const resetPass = document.getElementById('resetPass');
    const resetPass2= document.getElementById('resetPass2');
    const resetBtn  = document.getElementById('resetBtn');
    const resetErr  = document.getElementById('resetErr');
    const resetMsg  = document.getElementById('resetMsg');

    function showResetSheet(){ openSheet(document.getElementById('resetSheet')); setTimeout(()=> resetPass?.focus(), 0); }

    supabase.auth.onAuthStateChange((event, session)=>{
      setAuthUI(session);
      if(event === "PASSWORD_RECOVERY"){ showResetSheet(); }
    });

    // If redirected back with recovery hash
    (function checkHashForRecovery(){
      const hash = window.location.hash || "";
      if(hash.includes("type=recovery")) showResetSheet();
    })();

    resetForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      resetErr.textContent = ""; resetMsg.textContent = "";
      const p1 = resetPass.value || "";
      const p2 = resetPass2.value || "";
      if(p1.length < 8){ resetErr.textContent = "Password must be at least 8 characters."; return; }
      if(p1 !== p2){ resetErr.textContent = "Passwords don’t match."; return; }
      resetBtn.disabled = true; resetBtn.textContent = "Updating…";
      try{
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if(error) throw error;
        resetMsg.textContent = "Password updated. You can now log in.";
      }catch(err){
        resetErr.textContent = err?.message || "Could not update password.";
      }finally{
        resetBtn.disabled = false; resetBtn.textContent = "Update password";
      }
    });

    // ===== 3D tilt/parallax (reduced-motion aware) =====
    (function(){
      const card   = document.getElementById('videoCard');
      const slab   = document.getElementById('obsidianSlab');
      const frame  = document.getElementById('videoFrame');
      if(!card || !slab || !frame) return;

      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(prefersReduced) return;

      let raf = null;
      let rx=0, ry=0, prx=0, pry=0;

      function onMove(e){
        const rect = card.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top)  / rect.height;
        const max = 6;
        ry = (x - 0.5) * max;
        rx = (0.5 - y) * (max*0.6);
        if(raf===null){ raf = requestAnimationFrame(apply); }
      }
      function onLeave(){ rx=0; ry=0; if(raf===null) raf = requestAnimationFrame(apply); }
      const lerp=(a,b,t)=> a+(b-a)*t;

      function apply(){
        prx = lerp(prx, rx, 0.12);
        pry = lerp(pry, ry, 0.12);
        frame.style.transform = `translateZ(0px) rotateX(${prx}deg) rotateY(${pry}deg)`;
        slab.style.transform  = `translateZ(-18px) rotateX(${prx*0.6}deg) rotateY(${pry*0.6}deg)`;
        card.style.transform  = `rotateX(${prx*0.15}deg) rotateY(${pry*0.15}deg)`;
        if(Math.abs(prx-rx)>0.01 || Math.abs(pry-ry)>0.01){ raf = requestAnimationFrame(apply); } else { raf = null; }
      }

      card.addEventListener('pointermove', onMove);
      card.addEventListener('pointerleave', onLeave);
    })();

    // ===== Safe fit-to-container hero scaling (prevents initial collapse) =====
    (function(){
      const BASE = 980;                           // matches .hero-scale width
      const shell = document.getElementById('heroShell');
      const scaleEl = document.getElementById('heroScale');
      if(!shell || !scaleEl) return;

      function computeAvailableWidth(){
        // Try shell -> parent -> viewport; ensure a sane minimum
        const parent = shell.parentElement || document.body;
        const w1 = shell.clientWidth;
        const w2 = parent ? parent.clientWidth : 0;
        const w3 = window.innerWidth || 0;
        const w = Math.max(w1, w2, w3, 1);
        return w;
      }

      function fitHeroScale(){
        let available = computeAvailableWidth();
        let s = available / BASE;
        if(!Number.isFinite(s) || s <= 0) s = 1;
        s = Math.min(1, s);                      // never upscale
        scaleEl.style.transform = `scale(${s})`;

        // Use the *visual* height after transform so container never collapses
        const rect = scaleEl.getBoundingClientRect();
        const h = Math.max( Math.round(rect.height), Math.round(scaleEl.offsetHeight * s), 1 );
        shell.style.height = h + 'px';
      }

      // Run at safe times; defend against early 0-width paints
      const safeRun = () => { requestAnimationFrame(()=> requestAnimationFrame(fitHeroScale)); };

      window.addEventListener('load', safeRun, { once: true });
      window.addEventListener('resize', fitHeroScale);
      if('ResizeObserver' in window){ new ResizeObserver(fitHeroScale).observe(scaleEl); }
      if(document.fonts && document.fonts.ready){ document.fonts.ready.then(fitHeroScale); }

      // Initial
      safeRun();
    })();

    supabase.auth.onAuthStateChange((_event, session)=> setAuthUI(session));
    refreshSessionUI();
  </script>
</body>
</html>
